#!/usr/bin/env sh
binname=$0
while (readlink $binname > /dev/null)
do
    binname=$(readlink -f $binname)
done

project_dir=$(dirname $binname)
project_dir=$(dirname $project_dir)

uclash_src=$(command -v uclash)
if [ -z "$uclash_src" ]
then alias uclash="node $project_dir/bin/uclash"
fi

case $1 in 
    "")
        echo "uc.sh is a wrapper of of uclash.js for more functionalities"
        uclash
        echo "  install-clash      "
        echo "  install-premium    "
        echo "  f|find             "
        echo "  g|gen              generate profile with git pull and push"
        echo "  cron               "
        ;;
    install-clash)
        bash $project_dir/scripts/install-clash.sh $2 $3
        ;;
    install-premium)
        bash $project_dir/scripts/install-premium-in-termux.sh
        ;;
    f|find)
        bash $project_dir/scripts/find-proxy.sh
        ;;
    g|gen)
        profiles=$(uclash config -a -k profiles.folder)
        emoji=$(uclash expr "rE()")
        message_file=".message"
        cd $profiles
        if git pull
        then 
            uclash g $2 $3 $4 $5
            code=$?
        else 
            code=201
        fi
        if [ "$code" -eq 0 ]
        then
            git add .
            cat <<EOF >$message_file
$emoji $(uname -mnrs)
uptime: $(uptime)
EOF
            git commit --file $message_file
            rm $message_file
            git push

            if (command -v clash)
            then
                clash -t -f $(uclash p -c $2)
            fi
        fi
        exit $code
        ;;
    cron)
        profile=$2
        cat <<EOF >$HOME/.clash-update.sh
if (sh $project_dir/bin/uclash.sh gen $profile)
then
    sh $project_dir/bin/uclash.sh reload $profile
fi
EOF
        echo "* */4 * * * sh $HOME/.clash-update.sh >>$HOME/.clash-update.log" >$PREFIX/tmp/uclash.crontab
        crontab $PREFIX/tmp/uclash.crontab
        ;;
    r|reload)
        file=$(uclash p -c $2)
        clash_controller=$3
        if [ -z $3 ]
        then clash_controller="127.0.0.1:9090"
        fi
        curl -X PUT http://$clash_controller/configs \
            -H "Content-Type:application/json" \
            -d "{\"path\":\"$file\"}"
        ;;
    *)
        uclash $*
esac
